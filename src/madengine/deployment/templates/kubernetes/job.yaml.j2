apiVersion: batch/v1
kind: Job
metadata:
  name: {{ job_name }}
  namespace: {{ namespace }}
  labels:
    app: madengine
    model: {{ model_name }}
    madengine-job: "true"
spec:
  completions: {{ completions }}
  parallelism: {{ parallelism }}
  {% if completion_mode %}
  completionMode: {{ completion_mode }}
  {% endif %}
  backoffLimit: {{ backoff_limit }}
  template:
    metadata:
      labels:
        app: madengine
        job-name: {{ job_name }}
        model: {{ model_name }}
    spec:
      restartPolicy: Never
      terminationGracePeriodSeconds: 60
      {% if subdomain %}
      subdomain: {{ subdomain }}
      {% endif %}
      {% if node_selector %}
      nodeSelector:
        {% for key, value in node_selector.items() %}
        {{ key }}: "{{ value }}"
        {% endfor %}
      {% endif %}
      {% if host_ipc %}
      hostIPC: true
      {% endif %}
      
      # Init container extracts madengine scripts from package
      initContainers:
      - name: extract-scripts
        image: {{ image }}
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            echo "=== Extracting madengine scripts ==="
            
            # Extract common scripts from ConfigMap (since madengine not installed in container)
            {% if common_script_contents %}
            echo "Extracting common scripts from ConfigMap..."
            {% for script_path, script_content in common_script_contents.items() %}
            mkdir -p /workspace/{{ script_path | dirname }}
            cp /config/{{ script_path | replace("/", "-") }} /workspace/{{ script_path }}
            chmod +x /workspace/{{ script_path }} 2>/dev/null || true
            {% endfor %}
            echo "✓ Extracted {{ common_script_contents | length }} common script(s)"
            {% else %}
            echo "No common scripts to extract"
            {% endif %}
            
            # Copy K8s data provider script from ConfigMap if it exists
            if [ -f /config/data_provider.sh ]; then
                echo "Copying data_provider.sh to /workspace/data_provider.sh"
                cp /config/data_provider.sh /workspace/data_provider.sh
                chmod +x /workspace/data_provider.sh
                echo "✓ Copied K8s data provider script"
            fi
            
            # Create model script directory structure
            {% if model_script_dir %}
            mkdir -p /workspace/{{ model_script_dir }}
            
            # Copy run script from ConfigMap if it exists
            if [ -f /config/run.sh ]; then
                echo "Copying run.sh to /workspace/{{ model_script_path }}"
                cp /config/run.sh /workspace/{{ model_script_path }}
                chmod +x /workspace/{{ model_script_path }}
            else
                echo "Warning: run.sh not found in ConfigMap"
            fi
            {% else %}
            echo "Warning: No model script path configured"
            {% endif %}
            
            echo "✓ Script extraction complete"
        volumeMounts:
        - name: workspace
          mountPath: /workspace
        - name: config
          mountPath: /config
          readOnly: true
      
      # Main container runs benchmark
      containers:
      - name: {{ job_name }}
        image: {{ image }}
        imagePullPolicy: {{ image_pull_policy }}
        workingDir: /workspace
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            echo "==================================================================="
            echo "MADEngine Kubernetes Benchmark Job"
            echo "Model: {{ model_name }}"
            echo "Pod: $HOSTNAME"
            {% if launcher_type %}
            echo "Launcher: {{ launcher_type }}"
            {% endif %}
            echo "==================================================================="
            
            # Copy config files from ConfigMap to workspace
            cp /config/build_manifest.json /workspace/
            cp /config/credential.json /workspace/ 2>/dev/null || true
            cp /config/data.json /workspace/ 2>/dev/null || true
            
            # GPU Information
            if command -v rocm-smi &> /dev/null; then
                echo ""
                echo "=== AMD GPU Information ==="
                rocm-smi || true
            fi
            
            # Set GPU visibility
            export ROCR_VISIBLE_DEVICES=${ROCR_VISIBLE_DEVICES:-{{ gpu_visibility }}}
            export MAD_SYSTEM_GPU_ARCHITECTURE={{ gpu_architecture }}
            
            # K8s environment
            export MAD_K8S_POD_NAME=$HOSTNAME
            export MAD_K8S_NAMESPACE={{ namespace }}
            export MAD_K8S_JOB=true
            export MAD_DEPLOYMENT_TYPE=kubernetes
            
            # Data provider environment variables
            {% if data_config %}
            echo ""
            echo "=== Setting up data environment ==="
            export MAD_DATANAME="{{ data_config.data_name }}"
            {% for key, value in data_config.env_vars.items() %}
            export {{ key }}="{{ value }}"
            {% endfor %}
            echo "✓ Data environment configured for: {{ data_config.data_name }}"
            {% endif %}
            
            # Tools configuration environment variables
            {% if tools_config %}
            echo ""
            echo "=== Applying tools configuration ==="
            {% for tool in tools_config %}
            echo "Tool: {{ tool.name }}"
            {% if tool.env_vars %}
            {% for key, value in tool.env_vars.items() %}
            export {{ key }}="{{ value }}"
            {% endfor %}
            {% endif %}
            {% endfor %}
            echo "✓ Tools configuration applied"
            {% endif %}
            
            {% if launcher_command %}
            # Launcher-based execution
            echo ""
            echo "=== Starting benchmark with {{ launcher_type }} ==="
            {{ launcher_command | indent(12) }}
            {% else %}
            # Direct script execution
            cd /workspace
            
            # Download data if data provider is configured
            {% if data_provider_script and data_config %}
            echo ""
            echo "=== Data Provider: {{ data_config.provider_type }} ==="
            echo "Data name: {{ data_config.data_name }}"
            echo "Source: {{ data_config.source_url }}"
            echo "Target: {{ data_config.datahome }}"
            
            # Use K8s data provider script (loaded from ConfigMap)
            if [ -f /workspace/data_provider.sh ]; then
                bash /workspace/data_provider.sh \
                  "{{ data_config.data_name }}" \
                  "{{ data_config.source_url }}" \
                  "{{ data_config.datahome }}"
                
                # Source metrics if available
                if [ -f /tmp/mad_metrics.env ]; then
                    source /tmp/mad_metrics.env
                    echo "✓ Data metrics: Duration=${MAD_DATA_DOWNLOAD_DURATION}s, Size=${MAD_DATA_SIZE}"
                fi
            else
                echo "Error: Data provider script not found at /workspace/data_provider.sh"
                exit 1
            fi
            {% endif %}
            
            # Run pre-scripts (like local execution)
            {% if pre_scripts %}
            echo ""
            echo "=== Running pre-scripts ==="
            {% for script in pre_scripts %}
            # Execute: {{ script.path }}
            if [ -f "{{ script.path }}" ]; then
                echo "Executing: {{ script.path }} {% if script.args %}{{ script.args }}{% endif %}"
                bash {{ script.path }} {% if script.args %}{{ script.args }}{% endif %} || echo "Warning: {{ script.path }} failed with exit code $?"
            else
                echo "Warning: Script not found: {{ script.path }}"
            fi
            {% endfor %}
            echo "✓ Pre-scripts completed"
            {% else %}
            echo "No pre-scripts configured"
            {% endif %}
            
            # Run main model script
            echo ""
            echo "=== Running model benchmark script ==="
            if [ -f "{{ model_script }}" ]; then
                bash {{ model_script }}
                MODEL_EXIT_CODE=$?
            else
                echo "ERROR: Script not found: {{ model_script }}"
                echo "Available files in /workspace:"
                ls -la /workspace/
                echo ""
                echo "Available files in /workspace/scripts:"
                ls -la /workspace/scripts/ 2>/dev/null || echo "scripts/ directory not found"
                exit 1
            fi
            
            # Run post-scripts (like local execution)
            {% if post_scripts %}
            echo ""
            echo "=== Running post-scripts ==="
            {% for script in post_scripts %}
            # Execute: {{ script.path }}
            if [ -f "{{ script.path }}" ]; then
                echo "Executing: {{ script.path }} {% if script.args %}{{ script.args }}{% endif %}"
                bash {{ script.path }} {% if script.args %}{{ script.args }}{% endif %} || echo "Warning: {{ script.path }} failed with exit code $?"
            else
                echo "Warning: Script not found: {{ script.path }}"
            fi
            {% endfor %}
            echo "✓ Post-scripts completed"
            {% else %}
            echo "No post-scripts configured"
            {% endif %}
            
            # Exit with model script exit code
            exit ${MODEL_EXIT_CODE:-1}
            {% endif %}
            
            # Copy results to shared storage
            {% if results_pvc %}
            if [ -f "perf.csv" ]; then
                cp perf.csv /results/perf_${HOSTNAME}.csv
                echo "Results saved to /results/perf_${HOSTNAME}.csv"
            fi
            {% endif %}
            
            echo ""
            echo "=== Benchmark job completed with exit code ${MODEL_EXIT_CODE:-0} ==="
            exit ${MODEL_EXIT_CODE:-0}
        
        resources:
          requests:
            {{ gpu_resource_name }}: "{{ gpu_count }}"
            memory: "{{ memory }}"
            cpu: "{{ cpu }}"
          limits:
            {{ gpu_resource_name }}: "{{ gpu_count }}"
            memory: "{{ memory_limit }}"
            cpu: "{{ cpu_limit }}"
        
        env:
        {% for key, value in env_vars.items() %}
        - name: {{ key }}
          value: "{{ value }}"
        {% endfor %}
        
        volumeMounts:
        - name: workspace
          mountPath: /workspace
        - name: config
          mountPath: /config
          readOnly: true
        - name: shm
          mountPath: /dev/shm
        {% if results_pvc %}
        - name: results
          mountPath: /results
        {% endif %}
        {% if data_pvc %}
        - name: data
          mountPath: /data
          readOnly: true
        {% endif %}
        
        securityContext:
          capabilities:
            add:
            - SYS_PTRACE
          seccompProfile:
            type: Unconfined
      
      {% if tolerations %}
      tolerations:
      {% for toleration in tolerations %}
      - key: {{ toleration.key }}
        {% if toleration.operator %}
        operator: {{ toleration.operator }}
        {% endif %}
        {% if toleration.value %}
        value: "{{ toleration.value }}"
        {% endif %}
        {% if toleration.effect %}
        effect: {{ toleration.effect }}
        {% endif %}
      {% endfor %}
      {% endif %}
      
      volumes:
      - name: workspace
        emptyDir: {}
      - name: config
        configMap:
          name: {{ configmap_name }}
      - name: shm
        emptyDir:
          medium: Memory
          sizeLimit: 8Gi
      {% if results_pvc %}
      - name: results
        persistentVolumeClaim:
          claimName: {{ results_pvc }}
      {% endif %}
      {% if data_pvc %}
      - name: data
        persistentVolumeClaim:
          claimName: {{ data_pvc }}
      {% endif %}

