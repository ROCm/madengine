# SLURM Cluster Inventory for MADEngine
# Generated on {{ generation.timestamp }}

slurm_cluster:
  # SLURM login/head node configuration
  login_node:
    hostname: "{{ slurm.login_node.hostname | default('slurm-login') }}"
    address: "{{ slurm.login_node.address | default('localhost') }}"
    port: {{ slurm.login_node.port | default(22) }}
    username: "{{ slurm.login_node.username | default('madengine') }}"
    ssh_key_path: "{{ slurm.login_node.ssh_key_path | default('~/.ssh/id_rsa') }}"
    
  # SLURM cluster configuration
  cluster_name: "{{ slurm.cluster_name | default('madengine-cluster') }}"
  
  # Available partitions
  partitions:
{% for partition in slurm.partitions %}
    - name: "{{ partition.name }}"
      max_time: "{{ partition.max_time | default('24:00:00') }}"
      max_nodes: {{ partition.max_nodes | default(32) }}
      default_gpu_count: {{ partition.default_gpu_count | default(1) }}
      gpu_types: {{ partition.gpu_types | default(['generic']) | to_yaml | indent(8) }}
      memory_per_node: "{{ partition.memory_per_node | default('256G') }}"
      {% if partition.qos %}
      qos: "{{ partition.qos }}"
      {% endif %}
      {% if partition.account %}
      account: "{{ partition.account }}"
      {% endif %}
{% endfor %}

  # Workspace configuration
  workspace:
    shared_filesystem: "{{ workspace.shared_filesystem | default('/shared/madengine') }}"
    results_dir: "{{ workspace.results_dir | default('/shared/results') }}"
    logs_dir: "{{ workspace.logs_dir | default('logs') }}"
    venv_path: "{{ workspace.venv_path | default('venv') }}"
    
  # Module system
  modules:
{% for module in slurm.modules %}
    - "{{ module }}"
{% endfor %}
    
  # Environment variables
  environment:
{% for key, value in slurm.environment.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}

  # GPU vendor mapping
  gpu_mapping:
{% for vendor, config in slurm.gpu_mapping.items() %}
    {{ vendor }}:
      gres_name: "{{ config.gres_name | default('gpu') }}"
      constraint: "{{ config.constraint | default('') }}"
      memory_per_gpu: "{{ config.memory_per_gpu | default('16G') }}"
{% endfor %}

  # Job execution settings
  execution:
    max_concurrent_jobs: {{ slurm.execution.max_concurrent_jobs | default(8) }}
    job_array_strategy: {{ slurm.execution.job_array_strategy | default(true) }}
    default_timeout: {{ slurm.execution.default_timeout | default(3600) }}
    retry_failed_jobs: {{ slurm.execution.retry_failed_jobs | default(true) }}
    max_retries: {{ slurm.execution.max_retries | default(3) }}

# Model-specific overrides (if needed)
{% if model_overrides %}
model_overrides:
{% for model_tag, overrides in model_overrides.items() %}
  "{{ model_tag }}":
{% for key, value in overrides.items() %}
    {{ key }}: {{ value | to_yaml }}
{% endfor %}
{% endfor %}
{% endif %}