apiVersion: v1
kind: Service
metadata:
  name: {{ k8s.service.name | default('madengine-service') }}
  namespace: {{ k8s.namespace | default('madengine') }}
  labels:
    app.kubernetes.io/name: madengine
    app.kubernetes.io/component: service
    app.kubernetes.io/version: {{ generation.version | default('1.0.0') }}
  annotations:
    generated-on: "{{ generation.timestamp }}"
    environment: "{{ environment | default('default') }}"
spec:
  type: {{ k8s.service.type | default('ClusterIP') }}
  
  {% if k8s.service.type == 'LoadBalancer' and k8s.service.load_balancer_ip %}
  loadBalancerIP: {{ k8s.service.load_balancer_ip }}
  {% endif %}
  
  {% if k8s.service.type == 'LoadBalancer' and k8s.service.load_balancer_source_ranges %}
  loadBalancerSourceRanges:
    {% for range in k8s.service.load_balancer_source_ranges %}
    - {{ range }}
    {% endfor %}
  {% endif %}
  
  {% if k8s.service.external_ips %}
  externalIPs:
    {% for ip in k8s.service.external_ips %}
    - {{ ip }}
    {% endfor %}
  {% endif %}
  
  {% if k8s.service.cluster_ip %}
  clusterIP: {{ k8s.service.cluster_ip }}
  {% endif %}
  
  {% if k8s.service.external_name %}
  externalName: {{ k8s.service.external_name }}
  {% endif %}
  
  ports:
  {% if k8s.service.ports %}
    {% for port in k8s.service.ports %}
    - name: {{ port.name | default('http') }}
      port: {{ port.port }}
      targetPort: {{ port.target_port | default(port.port) }}
      {% if port.protocol %}
      protocol: {{ port.protocol }}
      {% endif %}
      {% if port.node_port and k8s.service.type == 'NodePort' %}
      nodePort: {{ port.node_port }}
      {% endif %}
    {% endfor %}
  {% else %}
    # Default ports for MADEngine monitoring/logging
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
  {% endif %}
  
  selector:
    app.kubernetes.io/name: madengine
    app.kubernetes.io/component: execution
  
  {% if k8s.service.session_affinity %}
  sessionAffinity: {{ k8s.service.session_affinity }}
  {% if k8s.service.session_affinity == 'ClientIP' and k8s.service.session_affinity_config %}
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: {{ k8s.service.session_affinity_config.timeout_seconds | default(10800) }}
  {% endif %}
  {% endif %}
